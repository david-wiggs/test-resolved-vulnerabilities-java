package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.RequestParam;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.commons.text.StringEscapeUtils;
import org.yaml.snakeyaml.Yaml;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

@SpringBootApplication
@RestController
public class VulnerabilityTestApplication {

    private static final Logger logger = LogManager.getLogger(VulnerabilityTestApplication.class);
    private final ObjectMapper objectMapper = new ObjectMapper();
    private final Yaml yaml = new Yaml();

    public static void main(String[] args) {
        logger.info("Starting Vulnerability Test Application - SECURE VERSION!");
        SpringApplication.run(VulnerabilityTestApplication.class, args);
    }

    @GetMapping("/")
    public Map<String, Object> home() {
        logger.info("Home endpoint accessed");
        
        Map<String, Object> response = new HashMap<>();
        response.put("message", "âœ… Vulnerability Test Application - SECURED!");
        response.put("description", "This Spring Boot app has been upgraded to secure dependency versions");
        response.put("timestamp", LocalDateTime.now());
        
        // Information about RESOLVED vulnerabilities
        Map<String, String> resolvedVulns = new HashMap<>();
        resolvedVulns.put("Jackson", "2.12.0 â†’ 2.15.4 - Fixed deserialization vulnerabilities");
        resolvedVulns.put("Log4j", "2.14.1 â†’ 2.21.1 - Fixed Log4Shell CVE-2021-44228 and others");
        resolvedVulns.put("Commons-Text", "1.9 â†’ 1.11.0 - Fixed string interpolation RCE CVE-2022-42889");
        resolvedVulns.put("H2 Database", "1.4.200 â†’ 2.2.224 - Fixed multiple security issues");
        resolvedVulns.put("SnakeYAML", "1.27 â†’ 2.2 - Fixed deserialization vulnerabilities");
        resolvedVulns.put("Commons-Collections", "REMOVED - Dangerous deserialization RCE CVE-2015-6420");
        resolvedVulns.put("Spring Boot", "2.6.0 â†’ 3.2.0 - Major security improvements and patches");
        
        response.put("resolvedVulnerabilities", resolvedVulns);
        response.put("securityStatus", "SECURE - All known vulnerabilities resolved!");
        response.put("note", "ðŸŽ‰ This change should show positive resolved vulnerabilities feedback!");
        
        return response;
    }
    
    @GetMapping("/test-jackson")
    public Map<String, Object> testJackson(@RequestParam(defaultValue = "{\"test\": \"data\"}") String json) {
        logger.info("Testing Jackson with input: {}", json);
        
        Map<String, Object> response = new HashMap<>();
        try {
            // Demonstrate Jackson usage with SECURE version
            Object parsed = objectMapper.readValue(json, Object.class);
            response.put("status", "success");
            response.put("parsed", parsed);
            response.put("jacksonVersion", "2.15.4 (SECURE)");
        } catch (Exception e) {
            response.put("status", "error");
            response.put("error", e.getMessage());
        }
        
        return response;
    }
    
    @GetMapping("/test-commons")
    public Map<String, Object> testCommons(@RequestParam(defaultValue = "Hello World") String text) {
        logger.info("Testing Commons libraries with input: {}", text);
        
        Map<String, Object> response = new HashMap<>();
        
        // Use Commons Text (NOW SECURE)
        String escaped = StringEscapeUtils.escapeHtml4(text);
        response.put("escapedText", escaped);
        
        // Commons Collections removed (was dangerous)
        Map<String, Object> standardMap = new HashMap<>();
        standardMap.put("input", text);
        standardMap.put("timestamp", LocalDateTime.now().toString());
        response.put("standardJavaMap", standardMap);
        
        response.put("commonsTextVersion", "1.11.0 (SECURE)");
        response.put("commonsCollectionsStatus", "REMOVED (was dangerous CVE-2015-6420)");
        
        return response;
    }
    
    @GetMapping("/test-yaml")
    public Map<String, Object> testYaml(@RequestParam(defaultValue = "test: value\\nversion: 1.0") String yamlContent) {
        logger.info("Testing SnakeYAML with input: {}", yamlContent);
        
        Map<String, Object> response = new HashMap<>();
        try {
            // Use SnakeYAML (NOW SECURE)
            Object parsed = yaml.load(yamlContent);
            response.put("status", "success");
            response.put("parsed", parsed);
            response.put("snakeYamlVersion", "2.2 (SECURE)");
        } catch (Exception e) {
            response.put("status", "error");
            response.put("error", e.getMessage());
        }
        
        return response;
    }
    
    @GetMapping("/health")
    public Map<String, Object> health() {
        Map<String, Object> health = new HashMap<>();
        health.put("status", "UP");
        health.put("timestamp", LocalDateTime.now());
        health.put("application", "Vulnerability Test App");
        health.put("securityStatus", "SECURE - All vulnerabilities resolved! ðŸŽ‰");
        return health;
    }
}