package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.RequestParam;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.commons.text.StringEscapeUtils;
import org.apache.commons.collections.map.HashedMap;
import org.yaml.snakeyaml.Yaml;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

@SpringBootApplication
@RestController
public class VulnerabilityTestApplication {

    private static final Logger logger = LogManager.getLogger(VulnerabilityTestApplication.class);
    private final ObjectMapper objectMapper = new ObjectMapper();
    private final Yaml yaml = new Yaml();

    public static void main(String[] args) {
        logger.info("Starting Vulnerability Test Application with vulnerable dependencies...");
        SpringApplication.run(VulnerabilityTestApplication.class, args);
    }

    @GetMapping("/")
    public Map<String, Object> home() {
        logger.info("Home endpoint accessed");
        
        Map<String, Object> response = new HashMap<>();
        response.put("message", "üîç Vulnerability Test Application");
        response.put("description", "This Spring Boot app demonstrates dependencies with known vulnerabilities");
        response.put("timestamp", LocalDateTime.now());
        
        // Information about vulnerable dependencies
        Map<String, String> vulnerableDeps = new HashMap<>();
        vulnerableDeps.put("Jackson", "2.12.0 - Deserialization vulnerabilities");
        vulnerableDeps.put("Log4j", "2.14.1 - Log4Shell and other RCE vulnerabilities");
        vulnerableDeps.put("Commons-Text", "1.9 - String interpolation RCE");
        vulnerableDeps.put("Commons-Collections", "3.2.1 - Deserialization RCE");
        vulnerableDeps.put("H2 Database", "1.4.200 - Various security issues");
        vulnerableDeps.put("SnakeYAML", "1.27 - Deserialization vulnerabilities");
        
        response.put("vulnerableDependencies", vulnerableDeps);
        response.put("note", "When fixed, this should show positive feedback about resolved vulnerabilities!");
        
        return response;
    }
    
    @GetMapping("/test-jackson")
    public Map<String, Object> testJackson(@RequestParam(defaultValue = "{\"test\": \"data\"}") String json) {
        logger.info("Testing Jackson with input: {}", json);
        
        Map<String, Object> response = new HashMap<>();
        try {
            // Demonstrate Jackson usage
            Object parsed = objectMapper.readValue(json, Object.class);
            response.put("status", "success");
            response.put("parsed", parsed);
            response.put("jacksonVersion", "2.12.0 (vulnerable)");
        } catch (Exception e) {
            response.put("status", "error");
            response.put("error", e.getMessage());
        }
        
        return response;
    }
    
    @GetMapping("/test-commons")
    public Map<String, Object> testCommons(@RequestParam(defaultValue = "Hello World") String text) {
        logger.info("Testing Commons libraries with input: {}", text);
        
        Map<String, Object> response = new HashMap<>();
        
        // Use Commons Text (vulnerable)
        String escaped = StringEscapeUtils.escapeHtml4(text);
        response.put("escapedText", escaped);
        
        // Use Commons Collections (vulnerable)
        Map<String, Object> commonsMap = new HashedMap();
        commonsMap.put("input", text);
        commonsMap.put("timestamp", LocalDateTime.now().toString());
        response.put("commonsCollectionsMap", commonsMap);
        
        response.put("commonsTextVersion", "1.9 (vulnerable)");
        response.put("commonsCollectionsVersion", "3.2.1 (vulnerable)");
        
        return response;
    }
    
    @GetMapping("/test-yaml")
    public Map<String, Object> testYaml(@RequestParam(defaultValue = "test: value\nversion: 1.0") String yamlContent) {
        logger.info("Testing SnakeYAML with input: {}", yamlContent);
        
        Map<String, Object> response = new HashMap<>();
        try {
            // Use SnakeYAML (vulnerable)
            Object parsed = yaml.load(yamlContent);
            response.put("status", "success");
            response.put("parsed", parsed);
            response.put("snakeYamlVersion", "1.27 (vulnerable)");
        } catch (Exception e) {
            response.put("status", "error");
            response.put("error", e.getMessage());
        }
        
        return response;
    }
    
    @GetMapping("/health")
    public Map<String, Object> health() {
        Map<String, Object> health = new HashMap<>();
        health.put("status", "UP");
        health.put("timestamp", LocalDateTime.now());
        health.put("application", "Vulnerability Test App");
        health.put("securityStatus", "VULNERABLE - For testing purposes only!");
        return health;
    }
}